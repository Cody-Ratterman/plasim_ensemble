#!/bin/bash
# run-script generated by Most, modified by Cody Ratterman to run in sections with specified changes

# ----------------------------------------------------------------------------------- #
# ------------ Set length of sections and parts of runs here. (in years) ------------ #
# --- number of sections rounds down if *_YEARS variable is not divisible by YEARS -- #
# ----------------------------------------------------------------------------------- #
YEARS=100 # years in a section (**not the full run**)

CLIMA_YEARS=0 # years to run with prescribed climatology parameters

CONTROL_YEARS=100 # years to run with calculated parameters and control ozone profile

SNCASE_YEARS=100 # years to run with calculated parameters and supernova case ozone profile

CONTROL_OZONE_PROFILE='../O3profiles/N032_level_0237_controlRun_19July2021_r10_startYr1993.sra' # Control case ozone data
#'../O3profiles/N032_level_0237_Control-NOspe-Dec.sra' # Control case ozone data
SNCASE_OZONE_PROFILE='../O3profiles/N032_level_0237_SNCR20pc_100yr_31Aug2021_r10_startYr1993.sra' # Supernova case ozone data
O3OPT=2 # flag for radmod to use O3 profile from file (2 to read from file)
# ! (Make sure the radmod_namelist has NO3 in it or this will not work)
# You can also run using 0 for no O3 or 1 for idealized O3
#  In those cases the O3 files will NOT be used and there will be no difference
#  between "control" and "supernova"
# ----------------------------------------------------------------------------------- #
# ----------------------------------------------------------------------------------- #

TOTAL_YEARS=`expr $CLIMA_YEARS + $CONTROL_YEARS + $SNCASE_YEARS` # years in a full run
CLIMA_SECTIONS=`expr $CLIMA_YEARS / $YEARS` # number of prescribed climatology sections
CONTROL_SECTIONS=`expr $CONTROL_YEARS / $YEARS` # number of control case sections 
SNCASE_SECTIONS=`expr $SNCASE_YEARS / $YEARS` # number of supernova case sections
TOTAL_SECTIONS=`expr $TOTAL_YEARS / $YEARS` # number of sections making up a full run

EXP=ensemble.00     # experiment name (changed during runEnsemble script, line 42)
RUN_DIR=$PWD

main() {
    echo $EXP
    echo "section length: $YEARS"
    echo "climatology: $((CLIMA_SECTIONS * YEARS))"
    echo "control: $((CONTROL_SECTIONS * YEARS))"
    echo "supernova case: $((SNCASE_SECTIONS * YEARS))"
    echo "total: $TOTAL_YEARS"

    # remove origional pre-existing files
    rm -f plasim_restart
    rm -f Abort_Message
    # modify namelists
    sed -i -e 's/KICK.*/KICK=1/' plasim_namelist
    sed -i -e 's/NGUI.*/NGUI=0/' plasim_namelist
    sed -i -e 's/N_RUN_YEARS.*/N_RUN_YEARS=1/' plasim_namelist
    sed -i -e 's/N_RUN_MONTHS.*/N_RUN_MONTHS=0/' plasim_namelist

    sed -i -e 's/NOCEAN.*/NOCEAN=0/' oceanmod_namelist
    sed -i -e 's/NICE.*/NICE=0/' icemod_namelist
    sed -i -e 's/NLANDT.*/NLANDT=0/' landmod_namelist

    sed -i -e "s/multi.*/multi=${YEARS}/" ../template/PostProcessing/PP_NL_Long
    sed -i -e "s/multi.*/multi=${YEARS}/" ../template/PostProcessing/PP_NL_Short

    sed -i -e "s/NO3.*/NO3=${O3OPT}/" radmod_namelist

    # Set ozone profile as control case
    cp $CONTROL_OZONE_PROFILE ./N032_level_0237.sra
    echo " "
    echo "Climatology Control Case"
    echo "O3 profile file: " $CONTROL_OZONE_PROFILE

    SECTION_NUM=0
    while [ $SECTION_NUM -lt $CLIMA_SECTIONS ] # loop for each section in run
    do
        run_section
        post_process
        clean_up
    done

    # change namelists from climatology to calculated parameters
    sed -i -e 's/NOCEAN.*/NOCEAN=1/' oceanmod_namelist
    sed -i -e 's/NICE.*/NICE=1/' icemod_namelist
    sed -i -e 's/NLANDT.*/NLANDT=1/' landmod_namelist

    echo " "
    echo "Control Case"
    echo "O3 profile file: " $CONTROL_OZONE_PROFILE
    

    while [ $SECTION_NUM -lt $((CLIMA_SECTIONS + CONTROL_SECTIONS)) ] # loop for each section in run
    do
        run_section
        post_process
        clean_up
    done

    # Set ozone profile as supernova case
    cp $SNCASE_OZONE_PROFILE ./N032_level_0237.sra
    echo " "
    echo "Supernova Case"
    echo "O3 profile file: ", $SNCASE_OZONE_PROFILE

    while [ $SECTION_NUM -lt $TOTAL_SECTIONS ] # loop for each section in run
    do
        run_section
        post_process
        clean_up
        
    done
}

# Run a single section of a run (copied from most_plasim_run script)
run_section () {
    SECTION_NUM=`expr $SECTION_NUM + 1`
    DIRNAME=`printf 'section.%02d' $SECTION_NUM`
    mkdir $DIRNAME
    
    for (( YEAR=1; YEAR<=$YEARS; YEAR++ )); do # loop for each year in (section length) years
        DATANAME=`printf '%s.%03d' $EXP $YEAR`
        DIAGNAME=`printf '%s_DIAG.%03d' $EXP $YEAR`
        RESTNAME=`printf '%s_REST.%03d' $EXP $YEAR`
        mpiexec -np $(find ./*.x -executable | cut -d '_' -f 5 | cut -d 'p' -f 2 | cut -d '.' -f 1) $(find ./*.x -executable)
        [ -e Abort_Message ] && exit 1
        [ -e plasim_output ] && mv plasim_output $DIRNAME/$DATANAME
        [ -e plasim_diag ] && mv plasim_diag $DIRNAME/$DIAGNAME
        [ -e plasim_status ] && cp plasim_status plasim_restart
        [ -e plasim_status ] && mv plasim_status $DIRNAME/$RESTNAME
    done
}

# Run post processor on the previous section
post_process () {
    PP_Long_Sections=() # empty list
    
    # Define which sections should use supernova_PP_Long, all others use supernova_PP_Short
    PP_Long_Sections+=( 1 ) # first section
    PP_Long_Sections+=( $CLIMA_SECTIONS ) # last climatology section
    PP_Long_Sections+=( `expr $CLIMA_SECTIONS + 1` ) # first control case section
    PP_Long_Sections+=( `expr $CLIMA_SECTIONS + $CONTROL_SECTIONS` ) # last control case section
    PP_Long_Sections+=( `expr $CLIMA_SECTIONS + $CONTROL_SECTIONS + 1` ) # first supernova case section
    PP_Long_Sections+=( $TOTAL_SECTIONS ) # last section
    
    POSTPROCESSOR_DIR='../../postprocessor' # define postprocessor directory
    
    SECT_IN_PP_Long_Sections=false
    for sect in ${PP_Long_Sections[@]}; do
        if [ $SECTION_NUM -eq $sect ]
        then
            SECT_IN_PP_Long_Sections=true
            break
        fi
    done

    #the postprocessor is copied here to run because it cannot handle long path names and so running it here avoids that issue
    cp $POSTPROCESSOR_DIR/burn7.x ./
    if $SECT_IN_PP_Long_Sections # use post processing namelist wih more or less included data
    then
	./burn7.x ./$DIRNAME/$EXP.001 ./PostProcessing/section.$SECTION_NUM < ../template/PostProcessing/PP_NL_Long > ./PostProcessing/section.$SECTION_NUM.PP_output.txt
    else
	./burn7.x ./$DIRNAME/$EXP.001 ./PostProcessing/section.$SECTION_NUM < ../template/PostProcessing/PP_NL_Short > ./PostProcessing/section.$SECTION_NUM.PP_output.txt
    fi
}

# Return to run directory and tar previous section binary data files
clean_up () {
    cd $RUN_DIR
    tar -czf $DIRNAME.tar.gz $DIRNAME
    rm -r $DIRNAME
    rm burn7.x
}

# read command parameter(s) and call main function
[ $# == 1 ] && cd $1
main "$@"; exit
